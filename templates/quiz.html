<!DOCTYPE html>
<html>
<head>
    <title>Quiz</title>
    <style>
        #timer {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <a href="/">Home</a>
    <a href="/settings">Settings</a>
    <div id="timer">Time Remaining: <span id="time">{{ '%02d:%02d' % (timer_duration // 60, timer_duration % 60) }}</span></div>
    <form id="quizForm">
        <input type="hidden" id="question_ids" name="question_ids" value="{{ questions|map(attribute='id')|list|tojson }}">
        <div id="question-container">
            <!-- Questions will be dynamically loaded here -->
        </div>
        <div>
            <button type="button" id="prevButton" onclick="prevQuestion()" disabled>Previous</button>
            <button type="button" id="nextButton" onclick="nextQuestion()">Next</button>
        </div>
        <button type="button" onclick="submitQuiz()">Submit</button>
    </form>
    <div id="result"></div>
    <script>
        let timeLeft = {{ timer_duration }};
        const timerElement = document.getElementById('time');
        const totalTime = timeLeft;
        let currentQuestionIndex = 0;
        const questions = {{ questions|tojson | safe }};
        const questionContainer = document.getElementById('question-container');
        const userAnswers = {};  // Object to store user answers
        let timerInterval;

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz();
            }
            timeLeft -= 1;
        }

        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }

        function loadQuestion(index) {
            const question = questions[index];
            let questionHTML = `<div>
                <p>${question.question}</p>`;
            question.options.forEach((option, i) => {
                const checked = userAnswers[index] === option ? 'checked' : '';
                questionHTML += `<label>
                    <input type="radio" name="question${index}" value="${option}" ${checked}>
                    ${option}
                </label><br>`;
            });
            if (question.answer_details) {
                questionHTML += `<p><em>${question.answer_details}</em></p>`;
            }
            questionHTML += `</div>`;
            questionContainer.innerHTML = questionHTML;
        }

        function saveAnswer() {
            const formData = new FormData(document.getElementById('quizForm'));
            const selectedOption = formData.get(`question${currentQuestionIndex}`);
            userAnswers[currentQuestionIndex] = selectedOption;
        }

        function prevQuestion() {
            saveAnswer();
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion(currentQuestionIndex);
                updateNavigationButtons();
            }
        }

        function nextQuestion() {
            saveAnswer();
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion(currentQuestionIndex);
                updateNavigationButtons();
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevButton').disabled = currentQuestionIndex === 0;
            document.getElementById('nextButton').disabled = currentQuestionIndex === questions.length - 1;
        }

        function submitQuiz() {
            saveAnswer();
            clearInterval(timerInterval);  // Stop the timer
            const questionIds = JSON.parse(document.getElementById('question_ids').value);
            const answers = questionIds.map((_, index) => userAnswers[index] || "");
            const timeUsed = totalTime - timeLeft;
            const minutesUsed = Math.floor(timeUsed / 60);
            const secondsUsed = timeUsed % 60;
            fetch('/check_answers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question_ids: questionIds,
                    answers: answers
                })
            })
            .then(response => response.json())
            .then(data => {
                let resultHTML = `You scored ${data.score} out of ${data.total} (${((data.score / data.total) * 100).toFixed(2)}%)<br>`;
                resultHTML += `Time used: ${minutesUsed} minutes and ${secondsUsed} seconds out of ${Math.floor(totalTime / 60)} minutes.<br><br>`;
                data.results.forEach(result => {
                    resultHTML += `<div>
                        <p><strong>Question:</strong> ${result.question}</p>
                        <p><strong>Your Answer:</strong> ${result.user_answer}</p>
                        <p><strong>Correct:</strong> ${result.correct ? 'Yes' : 'No'}</p>
                        <p><strong>Details:</strong> ${result.answer_details}</p>
                    </div><br>`;
                });
                document.getElementById('result').innerHTML = resultHTML;
            });
        }

        // Initialize the first question and start the timer
        loadQuestion(currentQuestionIndex);
        updateNavigationButtons();
        startTimer();
    </script>
</body>
</html>
